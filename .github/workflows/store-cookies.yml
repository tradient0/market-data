name: Get Cookies and Store in Secrets

on:
  workflow_dispatch: # This allows you to manually trigger the workflow

jobs:
  get-cookies:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Run Puppeteer Script
      uses: tj-actions/puppeteer@v5
      id: puppeteer
      with:
        files: |
          getCookies.js

    - name: Store Cookies in GitHub Secrets
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }} # The PAT token stored in secrets
      run: |
        # Fetch the public key
        PUBLIC_KEY=$(curl -s -H "Authorization: token $PAT_TOKEN" https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key | jq -r .key)
        KEY_ID=$(curl -s -H "Authorization: token $PAT_TOKEN" https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key | jq -r .key_id)
        
        # Encrypt the cookies
        COOKIES=$(echo -n "${{ steps.puppeteer.outputs.cookies }}" | openssl rsautl -encrypt -pubin -inkey <(echo "$PUBLIC_KEY" | base64 --decode) | base64)
        
        # Store the encrypted cookies in GitHub Secrets
        curl -X PUT \
          -H "Authorization: token $PAT_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"encrypted_value\":\"$COOKIES\",\"key_id\":\"$KEY_ID\"}" \
          https://api.github.com/repos/${{ github.repository }}/actions/secrets/CORPORATE_ACTION_NSE_COOKIES
